(function(t,e){(function(n){"function"==typeof define&&define.amd?define(["jquery"],n):t.sammy=e.Sammy=n(t)})(function(t){var n,i="([^/]+)",o=/:([\w\d]+)/g,r=/\?([^#]*)?$/,a=function(t){return Array.prototype.slice.call(t)},s=function(t){return"[object Function]"===Object.prototype.toString.call(t)},u=function(t){return"[object Array]"===Object.prototype.toString.call(t)},c=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},l=function(t){return decodeURIComponent((t||"").replace(/\+/g," "))},h=encodeURIComponent,f=function(t){return(t+"").replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},p=function(t){return function(){return this.route.apply(this,[t].concat(Array.prototype.slice.call(arguments)))}},d={},g=!(!e.history||!history.pushState),v=[];return n=function(){var e,i,o=a(arguments);return n.apps=n.apps||{},0===o.length||o[0]&&s(o[0])?n.apply(n,["body"].concat(o)):"string"==typeof(i=o.shift())?(e=n.apps[i]||new n.Application,e.element_selector=i,o.length>0&&t.each(o,function(t,n){e.use(n)}),e.element_selector!=i&&delete n.apps[i],n.apps[e.element_selector]=e,e):void 0},n.VERSION="0.7.2",n.addLogger=function(t){v.push(t)},n.log=function(){var e=a(arguments);e.unshift("["+Date()+"]"),t.each(v,function(t,i){i.apply(n,e)})},e.console!==void 0?s(e.console.log.apply)?n.addLogger(function(){e.console.log.apply(e.console,arguments)}):n.addLogger(function(){e.console.log(arguments)}):"undefined"!=typeof console&&n.addLogger(function(){console.log.apply(console,arguments)}),t.extend(n,{makeArray:a,isFunction:s,isArray:u}),n.Object=function(e){return t.extend(this,e||{})},t.extend(n.Object.prototype,{escapeHTML:f,h:f,toHash:function(){var e={};return t.each(this,function(t,n){s(n)||(e[t]=n)}),e},toHTML:function(){var e="";return t.each(this,function(t,n){s(n)||(e+="<strong>"+t+"</strong> "+n+"<br />")}),e},keys:function(t){var e=[];for(var n in this)s(this[n])&&t||e.push(n);return e},has:function(e){return this[e]&&""!==t.trim(""+this[e])},join:function(){var t=a(arguments),e=t.shift();return t.join(e)},log:function(){n.log.apply(n,arguments)},toString:function(e){var n=[];return t.each(this,function(t,i){(!s(i)||e)&&n.push('"'+t+'": '+(""+i))}),"Sammy.Object: {"+n.join(",")+"}"}}),n.DefaultLocationProxy=function(t,e){this.app=t,this.is_native=!1,this.has_history=g,this._startPolling(e)},n.DefaultLocationProxy.fullPath=function(t){var e=(""+t).match(/^[^#]*(#.+)$/),n=e?e[1]:"";return[t.pathname,t.search,n].join("")},t.extend(n.DefaultLocationProxy.prototype,{bind:function(){var i=this,o=this.app,r=n.DefaultLocationProxy;t(e).bind("hashchange."+this.app.eventNamespace(),function(t,n){i.is_native!==!1||n||(i.is_native=!0,e.clearInterval(r._interval),r._interval=null),o.trigger("location-changed")}),g&&!o.disable_push_state&&(t(e).bind("popstate."+this.app.eventNamespace(),function(){o.trigger("location-changed")}),t("a").live("click.history-"+this.app.eventNamespace(),function(t){if(!(t.isDefaultPrevented()||t.metaKey||t.ctrlKey)){var n=r.fullPath(this);return this.hostname==e.location.hostname&&o.lookupRoute("get",n)&&"_blank"!==this.target?(t.preventDefault(),i.setLocation(n),!1):void 0}})),r._bindings||(r._bindings=0),r._bindings++},unbind:function(){t(e).unbind("hashchange."+this.app.eventNamespace()),t(e).unbind("popstate."+this.app.eventNamespace()),t("a").die("click.history-"+this.app.eventNamespace()),n.DefaultLocationProxy._bindings--,0>=n.DefaultLocationProxy._bindings&&(e.clearInterval(n.DefaultLocationProxy._interval),n.DefaultLocationProxy._interval=null)},getLocation:function(){return n.DefaultLocationProxy.fullPath(e.location)},setLocation:function(t){if(/^([^#\/]|$)/.test(t)&&(t=g&&!this.app.disable_push_state?"/"+t:"#!/"+t),t!=this.getLocation()){if(!g||this.app.disable_push_state||!/^\//.test(t))return e.location=t;history.pushState({path:t},e.title,t),this.app.trigger("location-changed")}},_startPolling:function(i){var o=this;if(!n.DefaultLocationProxy._interval){i||(i=10);var r=function(){var i=o.getLocation();(n.DefaultLocationProxy._last_location===void 0||i!=n.DefaultLocationProxy._last_location)&&e.setTimeout(function(){t(e).trigger("hashchange",[!0])},0),n.DefaultLocationProxy._last_location=i};r(),n.DefaultLocationProxy._interval=e.setInterval(r,i)}}}),n.Application=function(t){var e=this;this.routes={},this.listeners=new n.Object({}),this.arounds=[],this.befores=[],this.namespace=(new Date).getTime()+"-"+parseInt(1e3*Math.random(),10),this.context_prototype=function(){n.EventContext.apply(this,arguments)},this.context_prototype.prototype=new n.EventContext,s(t)&&t.apply(this,[this]),this._location_proxy||this.setLocationProxy(new n.DefaultLocationProxy(this,this.run_interval_every)),this.debug&&this.bindToAllEvents(function(t,n){e.log(""+e,t.cleaned_type,n||{})})},n.Application.prototype=t.extend({},n.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(e){return e?t(this.element_selector).find(e):t(this.element_selector)},use:function(){var t=a(arguments),e=t.shift(),i=e||"";try{t.unshift(this),"string"==typeof e&&(i="Sammy."+e,e=n[e]),e.apply(this,t)}catch(o){e===void 0?this.error("Plugin Error: called use() but plugin ("+(""+i)+") is not defined",o):s(e)?this.error("Plugin Error",o):this.error("Plugin Error: called use() but '"+(""+i)+"' is not a function",o)}return this},setLocationProxy:function(t){var e=this._location_proxy;this._location_proxy=t,this.isRunning()&&(e&&e.unbind(),this._location_proxy.bind())},log:function(){n.log.apply(n,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(e,n){var r,a,u=this,c=[],l=Array.prototype.slice.call(arguments,2);if(0===l.length&&s(n)&&(n=e,l=[n],e="any"),e=e.toLowerCase(),n.constructor==String){for(o.lastIndex=0;null!==(a=o.exec(n));)c.push(a[1]);n=RegExp(n.replace(o,i)+"$")}return t.each(l,function(t,e){"string"==typeof e&&(l[t]=u[e])}),r=function(t){var e={verb:t,path:n,callback:l,param_names:c};u.routes[t]=u.routes[t]||[],u.routes[t].push(e)},"any"===e?t.each(this.ROUTE_VERBS,function(t,e){r(e)}):r(e),this},get:p("get"),post:p("post"),put:p("put"),del:p("delete"),any:p("any"),mapRoutes:function(e){var n=this;return t.each(e,function(t,e){n.route.apply(n,e)}),this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(t,e,n){var i=this;n===void 0&&(n=e);var o=function(){var t,e,o;t=arguments[0],o=arguments[1],o&&o.context?(e=o.context,delete o.context):e=new i.context_prototype(i,"bind",t.type,o,t.target),t.cleaned_type=t.type.replace(i.eventNamespace(),""),n.apply(e,[t,o])};return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(o),this.isRunning()&&this._listen(t,o),this},trigger:function(t,e){return this.$element().trigger([t,this.eventNamespace()].join("."),[e]),this},refresh:function(){return this.last_location=null,this.trigger("location-changed"),this},before:function(t,e){return s(t)&&(e=t,t={}),this.befores.push([t,e]),this},after:function(t){return this.bind("event-context-after",t)},around:function(t){return this.arounds.push(t),this},onComplete:function(t){return this._onComplete=t,this},isRunning:function(){return this._running},helpers:function(e){return t.extend(this.context_prototype.prototype,e),this},helper:function(t,e){return this.context_prototype.prototype[t]=e,this},run:function(n){if(this.isRunning())return!1;var i=this;return t.each(this.listeners.toHash(),function(e,n){t.each(n,function(t,n){i._listen(e,n)})}),this.trigger("run",{start_url:n}),this._running=!0,this.last_location=null,/\#(.+)/.test(this.getLocation())||void 0===n||this.setLocation(n),this._checkLocation(),this._location_proxy.bind(),this.bind("location-changed",function(){i._checkLocation()}),this.bind("submit",function(e){var n=i._checkFormSubmission(t(e.target).closest("form"));return n===!1?e.preventDefault():!1}),t(e).bind("unload",function(){i.unload()}),this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var e=this;return this.trigger("unload"),this._location_proxy.unbind(),this.$element().unbind("submit").removeClass(e.eventNamespace()),t.each(this.listeners.toHash(),function(n,i){t.each(i,function(t,i){e._unlisten(n,i)})}),this._running=!1,this},destroy:function(){return this.unload(),delete n.apps[this.element_selector],this},bindToAllEvents:function(e){var n=this;return t.each(this.APP_EVENTS,function(t,i){n.bind(i,e)}),t.each(this.listeners.keys(!0),function(i,o){-1==t.inArray(o,n.APP_EVENTS)&&n.bind(o,e)}),this},routablePath:function(t){return t.replace(r,"")},lookupRoute:function(t,e){var n,i,o=this,r=!1,a=0;if(this.routes[t]!==void 0)for(n=this.routes[t].length;n>a;a++)if(i=this.routes[t][a],o.routablePath(e).match(i.path)){r=i;break}return r},runRoute:function(e,n,i,o){var r,a,s,u,c,h,f,p,d=this,g=this.lookupRoute(e,n);if(this.debug&&this.log("runRoute",[e,n].join(" ")),this.trigger("run-route",{verb:e,path:n,params:i}),i===void 0&&(i={}),t.extend(i,this._parseQueryString(n)),g){this.trigger("route-found",{route:g}),null!==(f=g.path.exec(this.routablePath(n)))&&(f.shift(),t.each(f,function(t,e){g.param_names[t]?i[g.param_names[t]]=l(e):(i.splat||(i.splat=[]),i.splat.push(l(e)))})),r=new this.context_prototype(this,e,n,i,o),s=this.arounds.slice(0),u=this.befores.slice(0),h=[r],i.splat&&(h=h.concat(i.splat)),a=function(){for(var t,e,n;u.length>0;)if(c=u.shift(),d.contextMatchesOptions(r,c[0])&&(t=c[1].apply(r,[r]),t===!1))return!1;return d.last_route=g,r.trigger("event-context-before",{context:r}),"function"==typeof g.callback&&(g.callback=[g.callback]),g.callback&&g.callback.length&&(e=-1,n=function(){e++,g.callback[e]?t=g.callback[e].apply(r,h):d._onComplete&&d._onComplete(r)},h.push(n),n()),r.trigger("event-context-after",{context:r}),t},t.each(s.reverse(),function(t,e){var n=a;a=function(){return e.apply(r,[n])}});try{p=a()}catch(v){this.error(["500 Error",e,n].join(" "),v)}return p}return this.notFound(e,n)},contextMatchesOptions:function(e,n,i){var o=n;if(("string"==typeof o||c(o))&&(o={path:o}),i===void 0&&(i=!0),t.isEmptyObject(o))return!0;if(u(o.path)){var r,a,s,l;for(r=[],a=0,l=o.path.length;l>a;a+=1)s=t.extend({},o,{path:o.path[a]}),r.push(this.contextMatchesOptions(e,s));var h=t.inArray(!0,r)>-1?!0:!1;return i?h:!h}if(o.only)return this.contextMatchesOptions(e,o.only,!0);if(o.except)return this.contextMatchesOptions(e,o.except,!1);var f=!0,p=!0;return o.path&&(c(o.path)||(o.path=RegExp(""+o.path+"$")),f=o.path.test(e.path)),o.verb&&(p="string"==typeof o.verb?o.verb===e.verb:o.verb.indexOf(e.verb)>-1),i?p&&f:!(p&&f)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(t){return this._location_proxy.setLocation(t)},swap:function(t,e){var n=this.$element().html(t);return s(e)&&e(t),n},templateCache:function(t,e){return e!==void 0?d[t]=e:d[t]},clearTemplateCache:function(){return d={}},notFound:function(t,e){var n=this.error(["404 Not Found",t,e].join(" "));return"get"===t?n:!0},error:function(t,e){if(e||(e=Error()),e.message=[t,e.message].join(" "),this.trigger("error",{message:e.message,error:e}),this.raise_errors)throw e;this.log(e.message,e)},_checkLocation:function(){var t,e;return t=this.getLocation(),this.last_location&&"get"==this.last_location[0]&&this.last_location[1]==t||(this.last_location=["get",t],e=this.runRoute("get",t)),e},_getFormVerb:function(e){var n,i,o=t(e);return i=o.find('input[name="_method"]'),i.length>0&&(n=i.val()),n||(n=o[0].getAttribute("method")),n&&""!==n||(n="get"),t.trim((""+n).toLowerCase())},_checkFormSubmission:function(e){var n,i,o,r,a;return this.trigger("check-form-submission",{form:e}),n=t(e),i=n.attr("action")||"",o=this._getFormVerb(n),this.debug&&this.log("_checkFormSubmission",n,i,o),"get"===o?(r=this._serializeFormParams(n),""!==r&&(i+="?"+r),this.setLocation(i),a=!1):(r=t.extend({},this._parseFormParams(n)),a=this.runRoute(o,i,r,e.get(0))),a===void 0?!1:a},_serializeFormParams:function(t){var e,n="",i=t.serializeArray();if(i.length>0)for(n=this._encodeFormPair(i[0].name,i[0].value),e=1;i.length>e;e++)n=n+"&"+this._encodeFormPair(i[e].name,i[e].value);return n},_encodeFormPair:function(t,e){return h(t)+"="+h(e)},_parseFormParams:function(t){var e,n={},i=t.serializeArray();for(e=0;i.length>e;e++)n=this._parseParamPair(n,i[e].name,i[e].value);return n},_parseQueryString:function(t){var e,n,i,o,a={};if(e=t.match(r),e&&e[1])for(n=e[1].split("&"),o=0;n.length>o;o++)i=n[o].split("="),a=this._parseParamPair(a,l(i[0]),l(i[1]||""));return a},_parseParamPair:function(t,e,n){return t[e]!==void 0?u(t[e])?t[e].push(n):t[e]=[t[e],n]:t[e]=n,t},_listen:function(t,e){return this.$element().bind([t,this.eventNamespace()].join("."),e)},_unlisten:function(t,e){return this.$element().unbind([t,this.eventNamespace()].join("."),e)}}),n.RenderContext=function(t){this.event_context=t,this.callbacks=[],this.previous_content=null,this.content=null,this.next_engine=!1,this.waiting=!1},n.RenderContext.prototype=t.extend({},n.Object.prototype,{then:function(t){if(!s(t)){if(!("string"==typeof t&&t in this.event_context))return this;var n=this.event_context[t];t=function(t){return n.apply(this.event_context,[t])}}var i=this;return this.waiting?this.callbacks.push(t):(this.wait(),e.setTimeout(function(){var e=t.apply(i,[i.content,i.previous_content]);e!==!1&&i.next(e)},0)),this},wait:function(){this.waiting=!0},next:function(t){this.waiting=!1,t!==void 0&&(this.previous_content=this.content,this.content=t),this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(e,n,i){var o=this;return this.then(function(){var r,a,u;return s(n)?(i=n,n={}):n=t.extend({},n),i&&this.then(i),"string"==typeof e?(u=e.match(/\.json$/)||n.json,r=u?n.cache===!0:n.cache!==!1,o.next_engine=o.event_context.engineFor(e),delete n.cache,delete n.json,n.engine&&(o.next_engine=n.engine,delete n.engine),r&&(a=this.event_context.app.templateCache(e))?a:(this.wait(),t.ajax(t.extend({url:e,data:{},dataType:u?"json":"text",type:"get",success:function(t){r&&o.event_context.app.templateCache(e,t),o.next(t)}},n)),!1)):e.nodeType?e.innerHTML:e.selector?(o.next_engine=e.attr("data-engine"),n.clone===!1?""+e.remove()[0].innerHTML:""+e[0].innerHTML):void 0})},loadPartials:function(t){var e;if(t){this.partials=this.partials||{};for(e in t)(function(e,n){e.load(t[n]).then(function(t){this.partials[n]=t})})(this,e)}return this},render:function(t,e,n,i){return s(t)&&!e?this.then(t):(s(e)?(i=n,n=e,e=null):n&&!s(n)&&(i=n,n=null),this.loadPartials(i).load(t).interpolate(e,t).then(n))},partial:function(t,e,n,i){return s(n)?this.render(t,e,i).swap(n):s(e)?this.render(t,{},n).swap(e):this.render(t,e,n).swap()},send:function(){var t=this,e=a(arguments),n=e.shift();return u(e[0])&&(e=e[0]),this.then(function(){return e.push(function(e){t.next(e)}),t.wait(),n.apply(n,e),!1})},collect:function(e,n,i){var o=this,r=function(){s(e)&&(n=e,e=this.content);var i=[],r=!1;return t.each(e,function(t,e){var a=n.apply(o,[t,e]);return a.jquery&&1==a.length&&(a=a[0],r=!0),i.push(a),a}),r?i:i.join("")};return i?r():this.then(r)},renderEach:function(e,n,i,o){return u(n)&&(o=i,i=n,n=null),this.load(e).then(function(r){var a=this;return i||(i=u(this.previous_content)?this.previous_content:[]),o?(t.each(i,function(t,i){var s={},u=this.next_engine||e;n?s[n]=i:s=i,o(i,a.event_context.interpolate(r,s,u))}),void 0):this.collect(i,function(t,i){var o={},a=this.next_engine||e;return n?o[n]=i:o=i,this.event_context.interpolate(r,o,a)},!0)})},interpolate:function(t,e,n){var i=this;return this.then(function(o,r){!t&&r&&(t=r),this.next_engine&&(e=this.next_engine,this.next_engine=!1);var a=i.event_context.interpolate(o,t,e,this.partials);return n?r+a:a})},swap:function(t){return this.then(function(e){return this.event_context.swap(e,t),e}).trigger("changed",{})},appendTo:function(e){return this.then(function(n){t(e).append(n)}).trigger("changed",{})},prependTo:function(e){return this.then(function(n){t(e).prepend(n)}).trigger("changed",{})},replace:function(e){return this.then(function(n){t(e).html(n)}).trigger("changed",{})},trigger:function(t,e){return this.then(function(n){return e===void 0&&(e={content:n}),this.event_context.trigger(t,e),n})}}),n.EventContext=function(t,e,i,o,r){this.app=t,this.verb=e,this.path=i,this.params=new n.Object(o),this.target=r},n.EventContext.prototype=t.extend({},n.Object.prototype,{$element:function(){return this.app.$element(a(arguments).shift())},engineFor:function(t){var e,n=this;return s(t)?t:(t=""+(t||n.app.template_engine),(e=t.match(/\.([^\.\?\#]+)$/))&&(t=e[1]),t&&s(n[t])?n[t]:n.app.template_engine?this.engineFor(n.app.template_engine):function(t){return t})},interpolate:function(t,e,n,i){return this.engineFor(n).apply(this,[t,e,i])},render:function(t,e,i,o){return new n.RenderContext(this).render(t,e,i,o)},renderEach:function(t,e,i,o){return new n.RenderContext(this).renderEach(t,e,i,o)},load:function(t,e,i){return new n.RenderContext(this).load(t,e,i)},loadPartials:function(t){return new n.RenderContext(this).loadPartials(t)},partial:function(t,e,i,o){return new n.RenderContext(this).partial(t,e,i,o)},send:function(){var t=new n.RenderContext(this);return t.send.apply(t,arguments)},redirect:function(){var e,n=a(arguments),i=this.app.getLocation(),o=n.length;if(o>1){for(var r=0,s=[],u=[],c={},l=!1;o>r;r++)"string"==typeof n[r]?s.push(n[r]):(t.extend(c,n[r]),l=!0);if(e=s.join("/"),l){for(var h in c)u.push(this.app._encodeFormPair(h,c[h]));e+="?"+u.join("&")}}else e=n[0];this.trigger("redirect",{to:e}),this.app.last_location=[this.verb,this.path],this.app.setLocation(e),RegExp(e).test(i)&&this.app.trigger("location-changed")},trigger:function(t,e){return e===void 0&&(e={}),e.context||(e.context=this),this.app.trigger(t,e)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(t,e){return this.app.swap(t,e)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(e){return t.parseJSON(e)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}}),n})})(jQuery,window);